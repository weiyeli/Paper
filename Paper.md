# 基于患者E-Health诊治数据的安全存储与管理

## 摘要

着眼于传统医疗信息系统中存在的医疗信息的安全存储和授权共享的问题，结合以太坊平台，设计了一个基于电子病历安全存储与授权共享系统。该设计通过以太坊平台来存储患者的电子病历信息和访问权限。患者可以安全有效地管理自己的诊治数据，还可以授权给医疗机构等第三方进行读取。该设计有效的实现了患者对于自身医疗数据的访问控制权限和对数据的安全存储。

关键词：安全存储、授权共享、以太坊、电子病历、访问控制权限

## Abstract

Focusing on the problem of secure storage and authorization sharing of medical information in traditional medical information systems, combined with the Ethereum platform, a secure storage and authorization sharing system based on electronic medical records was designed. The design stores the patient's electronic medical record information and access rights through the Ethereum platform. Patients can manage their diagnosis and treatment data safely and effectively, and can also be authorized to read by third parties such as medical institutions. The design effectively realizes the patient's access control authority for his own medical data and secure storage of data.

## 绪论

### 研究背景、目的与意义

医疗健康问题与每一个人都息息相关，患者的医疗记录（包括病历、化验单、CT图等）都是患者个人健康状况的有效证明，对于患者了解自身健康状态和调养十分重要。然而我国的医疗发展起步晚，医疗设施落后，医疗信息化和数字化进程缓慢，对于病人的医疗隐私数据也缺乏安全有效的管理。医疗信息数字化是未来的发展趋势，利用现代先进的计算机技术，可以减少传统医疗系统中重复的人力操作，使得诊治过程规范化。其中医疗数据（处方、病历记录、身份信息、文档信息）的安全存储和管理更是重中之重，在传统的解决方案中，需要提高电子医疗数据的权限、隐私、安全等，以维护数据的完整性、正确性、可靠性、安全性和隐私性。

另一方面，当前时代是大数据时代，数据的作用被极大的释放，医疗数据更是数据分析的宝贵来源。在传统的医疗信息系统中，由于信息缺乏安全存储，信息容易被不法分子利用，进行贩卖。同时，由于各种医疗机构之间的不信任，医疗数据的共享更是困难，逐渐的形成了"数据孤岛"。数据的不流通导致了协同诊治平台的推进困难，患者往返于各种医院和医疗机构，无法综合各个机构的诊治结果形成完善的就诊报告。

综上所述，设计一套可以独立于第三方医疗机构，对患者个人的医疗数据进行安全存储，同时可以由患者授权给第三方读取，方便不同的医院和医疗机构进行协同诊治的系统十分必要。

### 国内外研究现状

21世纪是信息化时代，个人数据被大量收集和利用，医疗数据也不例外。对医疗数据的挖掘和分析，有利于医疗机构进行对于疾病的研究和防控，但同时也会带来隐私问题。隐私保护是针对公开发布的数据采取的一系列措施，防止第三方通过数据挖掘等不法手段获取病人的敏感信息。在数据发布领域，学者提出了多种隐私保护模型，主要包括：t-closeness、I-多样性、k-匿名模型等。这些模型的原理都是通过隐藏公开的隐私数据和具体个人之间的关系，但是保证发布数据的信息公开可用。

### 论文内容与组织

本文主要描述电子病历安全存储和授权共享系统的实现。本文的主要内容共分为六章。

第一章，绪论，分析我国医疗系统数字化的进程，讨论了医疗数据安全存储和授权共享的重要性，对比了国内外关于隐私数据存储算法的发展和趋势。

第二章，相关理论介绍，介绍本文中研究设计的系统中所涉及的关键理论，主要包括：区块链技术、比特币技术、以太坊平台等。

第三章，提出基于以太坊平台的电子病历存储和授权共享方案，详细讨论了系统的整体框架和所用技术，经过编程验证得出实验结果。

第四章，主要讨论了系统设计开发过程中遇到的困难和解决办法。

第五章，总结和展望。

## 本论文相关理论

### 区块链技术

#### 定义

2008年，中本聪在《Bitcoin：A peer-to-peer Electronic Cash System》一文中首次提出了“区块链”的概念。但是该文着重描写比特币系统，对于区块链技术并没有给出具体的定义。在中本聪的论文中，区块和链被描述为一种用于记录比特币交易过程中交易历史的数据结构。维基百科对于区块链的定义是：区块链（英语：blockchain或block chain）是借由密码学串接并保护内容的串连交易记录（又称区块）。每一个区块包含了前一个区块的加密散列、对应的时间戳以及交易数据（通常用默克尔树算法计算的散列值表示），这样的设计使得区块内容具有难以篡改的特性。用区块链所串接的分布式账本能让两方有效纪录交易，且可永久查验此交易。本文认为区块链既是一种数据结构，又可以认为是分布式数据库，从广义上看它也代指一系列分布式记账技术，包括智能合约、共识机制等。

#### 区块链的应用

区块链最主要的应用在金融领域，特别是电子货币。区块链的共享价值被众多的加密货币，如比特币、莱特币、以太币等所效仿，并在工作量证明和加密算法上做了许多改进，如采用Proof-of-stake、Scrypt算法等。截止至今，区块链生态在全球逐步扩大，出现了智能合约区块链以太坊、区块链众筹ICO、资产代币化共享经济等新兴产业。

#### 工作原理

传统的金融交易系统，都需要可信赖的第三方金融机构作为担保，实践证明这种机制一直运转良好，但是这类系统仍然天生受制于“基于信任的模式”的弱点。传统的交易系统并不能实现完全不可逆的交易，因为现实中存在的第三方机构不能保证不会发生分歧。另一方面，第三方金融机构的存在，一定程度上增加了交易的复杂性。所以，人们需要一种电子支付系统，基于密码学原理而不基于信用。达成共识的买方和卖方可以直接进行交易，交易过程不需要第三方金融机构的参与，并且产生的交易是不可逆的。

![1](https://cdn.8btc.com/wp-content/uploads/2013/11/11.png)

​									图1  基于数字签名的电子货币

区块链或者说比特币的出现解决了上述难题，中本聪的论文中提出了一种完全通过peer-to-peer技术实现的电子现金交易系统。一般的电子交易系统无法解决"双重支付"的难题。所谓"双重支付"指的是同一枚电子货币被支付两次，为了解决"双重支付"的问题我们又要引入第三方机构来作为公证，这无疑不符合去中心化的特点。因此中本聪提出了一种解决方案，该系统通过随机散列对全部交易记录加上时间戳，将他们合并进一个持续增长的基于随机散列的工作量证明(proof-of-work)的链条作为交易记录，除非重新完成所有的工作量证明，否则这条链条被认为是不可更改的。只要互联网中大多数的计算能力没有合起来对系统发起攻击，那么可以认为这条链条是安全的。

#### 共识机制

共识机制常见于区块链领域中，即多个节点如何达成共识的机制。由于加密货币多数采用去中心化的区块链设计，节点是各处分散且平行的，所以必须设计一套制度，来维护系统的运作顺序与公平性，统一区块链的版本，并奖励提供资源维护区块链的使用者，以及惩罚恶意的危害者。这样的制度，必须依赖某种方式来证明，是由谁取得了一个区块链的打包权（或称记帐权），并且可以获取打包这一个区块的奖励；又或者是谁意图进行危害，就会获得一定的惩罚，这就是共识机制。常见的共识机制有以下几种：

1. **工作量证明**（Proof-of-Work，PoW），典型案例：比特币网络
2. **权益证明**（Proof-of-Stake，PoS，又译持有量证明），典型案例：以太坊
3. **股份授权证明**（Delegated-Proof-of-Stake，DPoS），典型案例：EOS
4. **容量证明**（Proof-of-space，PoSpace，又称 Proof-of-Capacity，PoC）

本文主要讨论工作量证明：

工作量证明（Proof-of-work）是比特币和以太坊等货币中最常用的算法，其核心依赖于密码学。在分析工作量证明算法前先介绍散列函数（哈希函数）的概念。一个散列函数是可以将任意大小的数据映射到固定大小的数据的函数。以MD5算法举例如下：

MD5(“Hello World”) = B10A8DB164E0754105B7A99BE72E3FE5

MD5(“Hello World!”) = RNG76287532E96365E841E92BFC50EDG

由上述结果可见，原文细小的改变都会导致随机散列值巨大的变化。

回到工作量证明算法，区块链通过共识算法来选举一位领导者来决定下一个区块的内容。领导者还要负责把该区块广播到网络，便于其他节点检验该内容的有效性。一个成员要想成为领导者并选择下一个添加到区块链的区块，必须要找到解决一个特定数学问题的方法。对该问题简单叙述如下：给定数据X，找到一个数n，使得X+n得到的哈希值是一个小于Y的数。举例如下：

Y = 10，X = “Hello World!”

hash(X) = hash(“Hello World”) = 0x0f = 15 ＞ 10

hash(x+1) = hash(“Hello World1”) = 0xff = 255 ＞ 10

hash(x+2) = hash(“Hello World2”) = 0x09 = 9 ＜ 10

因此，找到n为2满足要求。由于MD5函数式加密安全的，所以我们通过暴力求解来尝试所有的组合。我们把最快计算出上述结果的成员称为矿工，每一个区块被开发的时候，矿工会获得一部分奖励。在工作量证明中，其他节点通过检查区块的散列是否小于给定的数字来检验区块的有效性。

![3](https://cdn.8btc.com/wp-content/uploads/2013/11/31.png)

​							图2  区块链数据结构

另一方面，工作量证明解决了确定最长的链条作为可信任的区块链的问题，因为最长的链条被认为是安全的。最长的链条包含了最大的工作量，如果大多数的CPU被安全的节点控制，那么诚实的链条将会以最快的速度延伸，并超过其他的竞争链条。如果有攻击者想要对现在的区块进行篡改，那么攻击者需要完成当前区块之前的所有工作量，并最终超越现有的区块的工作量。经过证明，攻击者想要追赶上现有的区块，其成功概率呈指数化递减。但是，这不意味着区块链系统是绝对安全的。根据摩尔定律，硬件的运算速度在高速增加，而且诚实节点参与的网络状况也会有所变化。为了解决这种不安全的因素，工作量证明将难度与区块的生成速度的平均值相关联，如果区块生成的速度过快，那么难度将会提高。

### 智能合约

智能合约(smart contract)是一种特殊协议，在区块链内制定合约时使用，当中内含了函数(Function)，也能与其他合约进行互动、做决策、存储资料以及传送以太币等功能。智能合约主要提供验证及执行合约内所订立的条件。智能合约容许在没有第三方的情况下进行可信交易，这些交易可被追踪且不可逆转。智能合约的概念于1994年由从事智能合约和数字货币研究的尼克萨博(Nick Szabo)博士提出，尼克1996年在《Extopy》期刊上发表了对智能合约的描述，他认为智能合约是一个由数字表单指定的承诺，这个承诺包含关系到多方执行的一组协议。不同于法律意义上的合约概念，区块链领域的合约表达的是可以“自治自理”的计算机协议，这套协议具有自我执行、自我验证的属性。从技术上看，智能合约等价于一段被事先规定好逻辑和条款的计算机代码运行时的状态，同时，智能合约也提供了通用的用户接口，用户可以通过接口与用户交互。比特币是第一个实现了智能合约的产品，比特币的五种标准交易脚本提供了多方共同签名支付的脚本，又称多重签名支付，多重签名支付可以看做是智能合约的一种表现形式。

### 以太坊

以太坊（英语：Ethereum）最初由 Vitalik Buterin 在2013年提出，是一个开源的具有智能合约功能的公共区块链平台。以太坊通过其专用加密货币以太币(英语：Ether)提供去中心化的虚拟机来处理点对点合约。以太坊的愿景是创建一个无法停止，抗屏蔽（审查）和自我维持的去中心化世界计算机。它延伸了比特币的区块链概念：在全球范围的多个计算机上验证，存储，和复制交易数据（因此术语叫“分布式账本”）。以太坊（Ethereum）在这个概念上更进一步，使在全球范围的多个计算机上运行代码成为现实。比特币用来分布式储存数据的，以太坊用来分布式储存数据并且计算。这些小型的电脑运行程序叫做智能合约，合约由参与者在他们自己的机器上通过一种称为 ”以太坊虚拟机“的操作系统运行。可以简单的理解：比特币的基础区块链上面存储的是交易记录，而以太坊的基础区块链上存储的是一段可运行的程序代码。

## 基于以太坊的电子病历安全存储和授权共享方案

### 研究目标和研究内容

现代医疗的一大难题就是数据的获取，高昂的数据成本和患者对于隐私的谨慎使得获得医疗数据十分困难。在传统的医疗信息系统中，患者的医疗信息都由医院统一管理，患者的访问权限十分有限。针对上述问题，本文提出了一种基于区块链的电子病历管理方案，该方案采用以太坊智能合约为跨医疗机构的医疗数据创建去中心化的病历管理系统。该系统可以为用户提供一个全新的、去中心化的病历管理方案，使用区块链来保存管理电子病历。所有存储在这个系统的记录有以下特点：

1. 患者可以管理自己的病历，可以授权给医生查看和编辑
2. 利用独特的区块链属性，以及内含的加密模块，能够在处理敏感信息时为用户提供强大的保密技术

### 拟解决的关键科学问题

利用现在的以太坊平台提供的API，在平台上部署自定义的智能合约，通过智能合约来实现病历保存、授权、编辑等功能。

## 基于以太坊的电子病历安全存储和授权共享的具体实现

### 整体框架设计



### 智能合约设计



### 运行环境

### 开发技术

本系统基于Truffle框架搭建以太坊开发平台，通过Ganache搭建本地私有区块链进行验证，其中智能合约的开发语言为Solidity开发语言。

#### Solidity

Solidity是一种面向对象的高级语言，用于实现智能合约。 智能合约是管理以太坊内账户行为的程序。Solidity受C++，Python和JavaScript的影响，旨在针对以太坊虚拟机（EVM）。Solidity是静态类型的，支持继承，库和复杂的用户定义类型以及其他功能。通过Solidity，可以创建智能合约，例如投票，众筹，盲目拍卖和多重签名钱包。

#### Truffle

Truffle是一个使用以太坊虚拟机（EVM）的区块链的世界级开发环境，测试框架和资源管道，旨在使开发人员的生活更轻松。 通过Truffle，开发者可以：

+ 内置智能合约编译，链接，部署和二进制管理。
+ 快速开发的自动合同测试。
+ 可编写脚本的可扩展部署和迁移框架。
+ 用于部署到任意数量的公共和专用网络的网络管理。
+ 使用ERC190标准，使用EthPM和NPM进行包装管理。
+ 交互式控制台，用于直接合同通
+ 可配置的构建管道，支持紧密集成。
+ 在Truffle环境中执行脚本的外部脚本运行器。

#### Truffle-Contract

Truffle-Contract是对Web3.js的封装，是对以太坊智能合约的抽象，适用于Node和浏览器。

Truffle-Contract具有的特性：

+ 通过同步交易来获得更好的流量控制(在开发者确认已经开采之前，交易无法完成)
+ 承诺。减少回调地狱的产生，适用于ES6的async和await
+ 对交易提供默认值，例如address或者gas
+ 返回日志、交易的回调、同步产生的交易的哈希值

#### Ganache

Ganache是以太坊开发的个人区块链，可用于部署合同，开发应用程序和运行测试。它既可用作桌面应用程序，也可用作命令行工具（以前称为TestRPC）。Ganache适用于Windows，Mac和Linux。

#### Web3.js

web3.js是一个库集合，允许开发者使用HTTP，WebSocket或IPC连接与本地或远程以太坊节点进行交互。

## 问题与解决办法

### 遇到的问题

首先，区块链技术是比较新颖的一门技术，在对其开发前我们需要先了解其基本原理、工作机制。刚开始学习区块链时遇到的比较大的困难对共识机制的了解，共识机制指的是在分布式的环境下多个节点如何达成共识，在比特币中主要应用了工作量证明(Proof-of-Work)的方法。除此之外，对于时间戳服务器、双重支付的问题的理解也十分关键。

设计采用以太坊作为开发平台，以太坊是一个生态圈，含有许多的开发工具和开发框架。其中最重要的是Solidity语言，Solidity语言用来开发以太坊智能合约的语言，掌握其语法与特性十分重要。其次遇到的困难是学习Truffle框架，Truffle框架是一款以太坊的开发框架，帮助开发者优化了智能合约的编译、发布、交易等流程。Truffle框架还包含了一系列的子框架，包括：Truffle-Contract等。除此之外，对于Ganache等以太坊客户端的学习也十分困难，开发者要访问以太坊区块链必须通过相关客户端提供的API，有官方提供的Go语言客户端还有方便本地使用的Ganache客户端。其次，比较困难的是对于Web3.js库的学习，Web3.js库是一个封装了访问区块链相关API的JavaScrtpt库。简单来说，Web3.js是前端界面与区块链智能合约的桥梁，对于项目的搭建十分重要。

### 解决办法

接触一个新的领域，或者接触一门新的技术，都需要花大量的时间去熟悉才能掌握。特别是对于Solidity语言、Truffle框架、Web3.js库，国内非常少中文资源，最好的学习资料是官方文档。通过查阅官方文档，学习官方文档里的Demo，可以快速的入门。除了官方文档，Github上有非常优秀的开源项目，通过学习前人的代码，可以掌握高质量的开发技巧。

### 开发技巧



## 参考文献

[1] 梅颖. 安全存储医疗记录的区块链方法研究[N]. 江西：江西师范大学学报，2017，41(5).

[2] 曹敏姿，张琳琳，毕雪华，赵楷. 个性化(α ，l) - 多 样 性 k - 匿 名 隐 私 保 护 模 型[J]. 计算机科学，2018，45(11).