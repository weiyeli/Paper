# 基于患者E-Health诊治数据的安全存储与管理

## 摘要

着眼于传统医疗信息系统中存在的医疗信息的安全存储和授权共享的问题，结合以太坊平台，设计了一个基于电子病历安全存储与授权共享系统。该设计通过以太坊平台来存储患者的电子病历信息和访问权限。患者可以安全有效地管理自己的诊治数据，还可以授权给医疗机构等第三方进行读取。该设计有效的实现了患者对于自身医疗数据的访问控制权限和对数据的安全存储。

关键词：安全存储、授权共享、以太坊、电子病历、访问控制权限

## Abstract

Focusing on the problem of secure storage and authorization sharing of medical information in traditional medical information systems, combined with the Ethereum platform, a secure storage and authorization sharing system based on electronic medical records was designed. The design stores the patient's electronic medical record information and access rights through the Ethereum platform. Patients can manage their diagnosis and treatment data safely and effectively, and can also be authorized to read by third parties such as medical institutions. The design effectively realizes the patient's access control authority for his own medical data and secure storage of data.

## 绪论

### 研究背景、目的与意义

医疗健康问题与每一个人都息息相关，患者的医疗记录（包括病历、化验单、CT图等）都是患者个人健康状况的有效证明，对于患者了解自身健康状态和调养十分重要[1]。然而我国的医疗发展起步晚，医疗设施落后，医疗信息化和数字化进程缓慢，对于病人的医疗隐私数据也缺乏安全有效的管理。医疗信息数字化是未来的发展趋势，利用现代先进的计算机技术，可以减少传统医疗系统中重复的人力操作，使得诊治过程规范化。其中医疗数据（处方、病历记录、身份信息、文档信息）的安全存储和管理更是重中之重，在传统的解决方案中，需要提高电子医疗数据的权限、隐私、安全等，以维护数据的完整性、正确性、可靠性、安全性和隐私性。

另一方面，当前时代是大数据时代，数据的作用被极大的释放，医疗数据更是数据分析的宝贵来源。在传统的医疗信息系统中，由于信息缺乏安全存储，信息容易被不法分子利用，进行贩卖。同时，由于各种医疗机构之间的不信任，医疗数据的共享更是困难，逐渐的形成了"数据孤岛"。数据的不流通导致了协同诊治平台的推进困难，患者往返于各种医院和医疗机构，无法综合各个机构的诊治结果形成完善的就诊报告。

综上所述，设计一套可以独立于第三方医疗机构，对患者个人的医疗数据进行安全存储，同时可以由患者授权给第三方读取，方便不同的医院和医疗机构进行协同诊治的系统十分必要。

### 国内外研究现状

21世纪是信息化时代，个人数据被大量收集和利用，医疗数据也不例外。对医疗数据的挖掘和分析，有利于医疗机构进行对于疾病的研究和防控，但同时也会带来隐私问题。隐私保护是针对公开发布的数据采取的一系列措施，防止第三方通过数据挖掘等不法手段获取病人的敏感信息。在数据发布领域，学者提出了多种隐私保护模型，主要包括：t-closeness、I-多样性、k-匿名模型等。这些模型的原理都是通过隐藏公开的隐私数据和具体个人之间的关系，但是保证发布数据的信息公开可用[2]。

### 论文内容与组织

本文主要描述电子病历安全存储和授权共享系统的实现。本文的主要内容共分为六章。

第一章，绪论，分析我国医疗系统数字化的进程，讨论了医疗数据安全存储和授权共享的重要性，对比了国内外关于隐私数据存储算法的发展和趋势。

第二章，相关理论介绍，介绍本文中研究设计的系统中所涉及的关键理论，主要包括：区块链技术、比特币技术、以太坊平台等。

第三章，提出基于以太坊平台的电子病历存储和授权共享方案，详细讨论了系统的整体框架和所用技术，经过编程验证得出实验结果。

第四章，主要讨论了系统设计开发过程中遇到的困难和解决办法。

第五章，总结和展望。

## 本论文相关理论

### 区块链技术

#### 定义

2008年，中本聪在《Bitcoin：A peer-to-peer Electronic Cash System》一文中首次提出了“区块链”的概念。但是该文着重描写比特币系统，对于区块链技术并没有给出具体的定义。在中本聪的论文中，区块和链被描述为一种用于记录比特币交易过程中交易历史的数据结构。维基百科对于区块链的定义是：区块链（英语：blockchain或block chain）是一串连接起来的加密过的交易记录，每一个记录被称为一个区块。每一个区块包含了前一个区块的hash值、对应时间的时间戳以及交易记录，上述特点使得区块内容具不可篡改性。本文认为区块链既是一种数据结构，又可以认为是分布式数据库，从广义上看它也代指一系列分布式记账技术，包括智能合约、共识机制等。

#### 区块链体系架构

区块链平台自底向上可以分为数据层、网络层、共识层、合约层、应用层五个层次[5]。数据层采用默克尔树、交易结构、签名结构等数据结构与数据库对区块、交易进行存储；网络层采用P2P协议完成各个节点间的数据传输；共识层通过对应的算法和激励机制，解决了拜占庭容错和分布式一致性问题；合约层通过编写智能合约，让开发者再合约上可以进行交易；应用层提供公开的API接口，允许用户创建和运行智能合约。

![image-20190417234121182](https://ws3.sinaimg.cn/large/006tNc79gy1g2625rjvk1j30mk0kyq5h.jpg)

图  区块链技术架构

#### 区块链的应用场景

根据区块链的设计技术，区块链系统具有分布式高冗余存储、不可篡改、去中心化、自动执行的智能合约等特点。区块链不仅可以应用在金融领域，在医疗、社会系统中也有着巨大的应用潜力。区块链目前的应用场景主要有以下几方面：数字货币、数据存储、数据鉴证、金融交易、资产管理和投票选举六大场景[7]。

#### 工作原理

传统的金融交易系统，都需要可信赖的第三方金融机构作为担保，实践证明这种机制一直运转良好，但是这类系统仍然天生受制于“基于信任的模式”的弱点。传统的交易系统并不能实现完全不可逆的交易，因为现实中存在的第三方机构不能保证不会发生分歧。另一方面，第三方金融机构的存在，一定程度上增加了交易的复杂性。所以，人们需要一种电子支付系统，基于密码学原理而不基于信用。达成共识的买方和卖方可以直接进行交易，交易过程不需要第三方金融机构的参与，并且产生的交易是不可逆的。

![1](https://cdn.8btc.com/wp-content/uploads/2013/11/11.png)

​									图1  基于数字签名的电子货币

区块链或者说比特币的出现解决了上述难题，中本聪的论文中提出了一种完全通过peer-to-peer技术实现的电子现金交易系统。一般的电子交易系统无法解决"双重支付"的难题。所谓"双重支付"指的是同一枚电子货币被支付两次，为了解决"双重支付"的问题我们又要引入第三方机构来作为公证，这无疑不符合去中心化的特点。因此中本聪提出了一种解决方案，该系统通过随机散列对全部交易记录加上时间戳，将他们加入到一个不断延伸的基于hash值的工作量证明的链条作为交易记录，除非重新完成所有的工作量证明，否则这条链条被认为是不可更改的。只要互联网中大多数的计算能力没有合起来对系统发起攻击，那么可以认为这条链条是安全的[3]。

#### 共识机制

共识机制常见于区块链领域中，即多个节点如何达成共识的机制。由于区块链去中心化的特点，区块链中的各个节点是分布式的。要维护系统的运作顺序和公平性，必须设计一套算法，来统一调度和提供激励机制和惩罚机制。这样的制度，必须依赖某种方式来证明，由哪个节点获得记账权，并且可以获取记录这一个区块的奖励；或者惩罚攻击诚实节点的攻击者。这就是共识机制。常见的共识机制有以下几种：

1. **工作量证明**（Proof-of-Work，PoW），典型案例：比特币网络
2. **权益证明**（Proof-of-Stake，PoS，又译持有量证明），典型案例：以太坊
3. **股份授权证明**（Delegated-Proof-of-Stake，DPoS），典型案例：EOS
4. **容量证明**（Proof-of-space，PoSpace，又称 Proof-of-Capacity，PoC）

本文主要讨论工作量证明：

工作量证明（Proof-of-work）是比特币和以太坊等货币中最常用的算法，其核心依赖于密码学。在分析工作量证明算法前先介绍散列函数（哈希函数）的概念。散列函数是一种函数映射关系，可以将任何长度的数据映射到同一大小的数据。以MD5算法举例如下：

MD5(“Hello World”) = B10A8DB164E0754105B7A99BE72E3FE5

MD5(“Hello World!”) = RNG76287532E96365E841E92BFC50EDG

由上述结果可见，原文细小的改变都会导致随机散列值巨大的变化。

工作量证明算法中，区块链通过共识算法来推选一位Leader来记录下一个区块的内容。Leader还要负责把该区块广播到外界网络，方便其他节点检验该区块的有效性。对该问题简单叙述如下：给定数据X，找到一个数n，使得X+n得到的哈希值是一个小于Y的数。举例如下：

Y = 10，X = “Hello World!”

hash(X) = hash(“Hello World”) = 0x0f = 15 ＞ 10

hash(x+1) = hash(“Hello World1”) = 0xff = 255 ＞ 10

hash(x+2) = hash(“Hello World2”) = 0x09 = 9 ＜ 10

因此，找到n为2满足要求。由于MD5函数式加密安全的，所以我们通过暴力求解来尝试所有的组合。我们把最快计算出上述结果的成员称为矿工，每一个区块被开发的时候，矿工会获得一部分奖励。

![3](https://cdn.8btc.com/wp-content/uploads/2013/11/31.png)

​							图2  区块链数据结构

另一方面，工作量证明解决了确定最长的链条作为可信任的区块链的问题，因为最长的链条被认为是安全的。如果有攻击者想要对现在的区块进行篡改，那么攻击者需要完成当前区块之前的所有工作量，并最终超越现有的区块的工作量。经过证明，攻击者想要追赶上现有的区块，其成功概率呈指数化递减。但是，这不意味着区块链系统是绝对安全的。根据摩尔定律，硬件的运算速度在高速增加，而且诚实节点参与的网络状况也会有所变化。为了解决这种不安全的因素，工作量证明将难度与区块的生成速度的平均值相关联，如果区块生成的速度过快，那么难度将会提高。

#### 区块链的类型

区块链技术根据实际应用场景和需求具有公有链、联盟链和私有链三种应用模式[4]。他们的特点如下：

1. 公有链。公有链允许任何人自由进出，共识机制采用pow/pos/Dpos，需要所有人参与记账，需要激励机制，完全去中心化，每秒可以承载最多100笔交易，典型应用场景是加密货币，代表项目为：比特币、以太坊和EOS。
2. 联盟链。联盟链只允许联盟成员参与，共识机制采用分布式一致性算法，记账人由联盟成员协商确定，激励机制可选，弱中心化，每秒可承载最多10万笔交易，典型应用场景包括供应链金融、银行、物流、电商等，代表项目有R3、Hyperledger。
3. 私有链。私有链只允许链的所有者，共识机制为solo/pbft等，记账人为链的所有者，不需要激励机制，强中心化，承载能力视配置而定，典型场景包括大型组织、机构。

![image-20190417233227182](https://ws4.sinaimg.cn/large/006tNc79gy1g261wxuo7nj30zm0i0nb1.jpg)

### 智能合约

智能合约(smart contract)是一种特殊协议，在区块链内制定合约时使用，当中内含了函数(Function)，也能与其他合约进行互动、做决策、存储资料以及传送以太币等功能。智能合约主要提供验证及执行合约内所订立的条件。

智能合约容许在没有第三方参与的情况下进行可以被信赖的安全的交易，这些交易具有可追踪性和不可篡改行。

智能合约的概念于1994年由从事智能合约和数字货币研究的尼克萨博(Nick Szabo)博士提出，是与互联网同一时期的产物。当时因为智能合约没有可信的执行环境，智能合约只是一种理论，并没有被技术落地。比特币诞生后，技术人员发现比特币的底层技术支撑区块链是智能合约有效的执行环境，以太坊创始人首先发现了这一点，发布了白皮书《以太坊：下一代智能合约和去中心化应用平台》，并一直致力于将以太坊打造成最佳的智能合约平台，所以比特币依赖于区块链，而以太坊复活了智能合约。

比特币是第一个实现了智能合约的产品，比特币的五种标准交易脚本提供了多方共同签名支付的脚本，又称多重签名支付，多重签名支付可以看做是智能合约的一种表现形式。

![image-20190417231107846](https://ws2.sinaimg.cn/large/006tNc79ly1g261agxztaj30o00c6jti.jpg)

图  区块链上的智能合约模型结构 

### 以太坊

以太坊（英语：Ethereum）最初由 Vitalik Buterin 在2013年提出，是一个开源的具有智能合约功能的公共区块链平台。以太坊通过其专用加密货币以太币(英语：Ether)提供去中心化的虚拟机来处理点对点合约。以太坊创建的目的是创建一个可自我执行、抗审查和可以自我维护的去中心化的世界级计算机。它延伸了比特币的区块链概念：在分布式的计算机上存储、交易和验证数据。以太坊（Ethereum）在比特币的概念上作出了更加巨大的创新，使在被互联网连接的多个计算机上运行代码成为现实。可以简单的理解：比特币的基础区块链上面存储的是交易记录，而以太坊的基础区块链上存储的是一段可运行的程序代码。

#### 以太坊账户

以太坊的账户主要包括以下四个部分：

1. 一个随机值用作计数器，记录交易的次数，保证只能交易一次
2. 账户当前的以太币余额
3. 账户的合约代码(若无则为空)
4. 账户的存储(默认为空)

两个账户之间的交易信息和信息的状态转换构成了以太坊系统的"状态"。以太币(Ether)是以太坊里面的加密用度，主要用来支出交易用度。以太坊有两种类型账户：合约账户CA（Contracts Accounts）和外部账户EOA（Externally Owned Accounts）。

合约账户是智能合约代码用的账户，外部账户是人用的账户；所以合约账户可以存储并执行智能合约代码，它的"智能性"被外部账户激活。合约账户不存储和存储私钥，合约账户还可以调用其他合约。

外部账户是由使用以太坊的人直接使用的账户，可以存储以太币，可以发送交易到合约账户，触发既定的代码逻辑。外部账户由公钥标识，由对应的私钥控制。

当合约账户被调用时，存储在其中的智能合约可以在矿工处的虚拟机中自动执行，并消耗Gas，如果Gas不足则会触发"Out of Gas"异常，被终止执行。无论是合约账户还是外部账户，在以太坊内部都被看做状态对象。其中合约账户存储了余额和代码，外部账户存储了以太币的余额。

#### 消息和交易

以太坊的消息和比特币的交易相似，但是存在三点不同：

1. 比特币的交易只能由外界来创建，以太坊还可以通过合约创建
2. 以太坊消息可以选择包含数据
3. 以太坊消息包含了函数的概念

Ethereum中的“交易”指存储来自外部帐户的消息的签名包。交易包含消息的接收方、用于确认发送方的签名、以太网帐户余额、要发送的数据和两个名为Startgas和Gasprice的值。为了防止代码的指数级爆炸和无限循环，每个交易都需要限制执行代码所涉及的计算步骤，包括初始消息和在执行过程中引发的所有消息。Startgas是一个限制，而天然气价格是矿商每一步计算的成本。如果在交易执行期间“Gas用尽”，所有状态更改将返回到原始状态，但是所支付的交易成本是不可恢复的。如果交易执行中止时仍然存在Gas，则Gas将返回给发送方。所述创建契约具有单独的交易类型和相应的消息类型;契约的地址是根据帐户随机数和交易数据的哈希值计算的。

#### 以太坊状态转换函数

![image-20190419085040761](https://ws4.sinaimg.cn/large/006tNc79gy1g27nnop4k7j311m0jcwjc.jpg)

 图 以太坊状态转换函数

以太坊的状态转换函数：`APPLY(S,TX) -> S'`，可以定义如下：

1. 检验输入的格式是否正确。
2. 计算交易费用:`cost = STARTGAS * GASPRICE`，根据数字签名找到发送者的地址，并且发送者的账户中减去交易费用和增加发送者的计数器的取值。如果账户余额不足，返回错误。
3. 设定初值`cost_gas = STARTGAS`，并根据交易中的字节数减去一定量的Gas。
4. 从发送者的账户转移价值到接收者账户。如果接收账户还不存在，创建此账户。如果接收账户是一个合约，运行合约的代码，直到代码运行结束或者Gas用完。
5. 如果因为发送者账户余额不足或者Gas用完导致转移失败，则恢复账户原来的状态，但是还需要支付交易费用，交易费用转移至矿工账户。
6. 反之，将剩余的Gas归还给发送者，消耗的Gas支付给矿工。

## 基于以太坊的电子病历安全存储和授权共享方案

### 研究目标和研究内容

本系统是对原慢病移动监护协同诊治平台的子系统进行升级。“慢病移动监护协同诊治平台” (简称：“慢病家居监护平台”)，该开发平台通过APP端的手机移动模式，提供直观、方便、快捷的家居移动医疗监护数据的实时采集、上传云服务器，原有平台的功能组成图如下所示：

![image-20190417144939875](https://ws1.sinaimg.cn/large/006tNc79ly1g25msit94jj31460me12z.jpg)

​						图 3  平台功能组成图

本系统主要对原医疗协同平台系统中的电子病历管理和权限管理进行升级。

![image-20190417145119642](https://ws1.sinaimg.cn/large/006tNc79ly1g25mu9alkxj31110u0gzk.jpg)

​			图 4  平台模块调用关系图



原有平台的用户数据、医疗信息数据都存储在医院的关系型数据库中，由医院统一进行管理。现代医疗的一大难题就是数据的获取，高昂的数据成本和患者对于隐私的谨慎使得获得医疗数据十分困难。在传统的医疗信息系统中，患者的医疗信息都由医院统一管理，患者的访问权限十分有限。

针对上述问题，本文提出了一种基于区块链的电子病历管理方案，该方案采用以太坊智能合约为跨医疗机构的医疗数据创建去中心化的病历管理系统。该系统可以为用户提供一个全新的、去中心化的病历管理方案，使用区块链来保存管理电子病历。所有存储在这个系统的记录有以下特点：

1. 患者可以管理自己的病历
2. 患者可以将自己病历的权限赋予第三方机构，医生获得权限后可以查看和编辑患者的病历
3. 利用独特的区块链属性，以及内含的加密模块，能够在处理敏感信息时为用户提供强大的保密技术

### 拟解决的关键科学问题

去中心化的数据存储。如何保证数据能够安全的存储，不被第三方破解拿到数据，同时满足可以由患者自己管理数据，而且不依赖于某个特定的医疗机构。

数据共享。传统医疗机构间共享数据困难，困难点在于医疗数据的校验、保存和同步[6]。由于访问权限的限制，患者、医生和研究人员在读取和共享医疗数据十分困难，需要大量的权限检查和数据校验的过程。

## 基于以太坊的电子病历安全存储和授权共享的具体实现

### 整体框架设计

整体框架图如下：

![image-20190422224022025](https://ws2.sinaimg.cn/large/006tNc79gy1g2bshtqcfoj31be0qkq4q.jpg)

流程图如下：

![image-20190422223906144](https://ws3.sinaimg.cn/large/006tNc79gy1g2bsgkm3urj31da0qsjuh.jpg)

客户端采用了iOS平台，设计了一款医疗助手App。患者和医生都可以通过App注册和登录到系统，其中患者登录后可以查看自己的历史病历信息还可以预约挂号，患者预约某个医院相当于将自己的病历的访问控制权限授权给该医院的医生。该医院的医生拿到患者的授权后，可以查看到患者的历史病历信息。医生诊治后，可以在App上给患者新建病历，录入诊治内容，新建的病历会写入到以太坊的区块链中。

### 智能合约设计

```swift
contract Ehealth {
    address payable public patient;
    string name;
    string record;
    string gender;
    address myaddress;
    address checker;
    uint age;
     
    constructor(string memory _name, string memory _gender, uint _age) public {
        name = _name;
        gender = _gender;
        age = _age;
        myaddress  = msg.sender;
        checker = msg.sender;
    }
    
    modifier check() {
        require(
            msg.sender == myaddress || msg.sender == checker,
            "Only ath-person can do this ops."
            );
        _;
    }
    
    modifier check_doc() {
        require(
            msg.sender == checker,
            "Only doc can do this ops."
            );
        _;
    }
    
    event makeChange(address _a);
    
    function authens(address _checker) public{
        checker = _checker;
    }
    
    function unAuth() public check{
        checker = myaddress;
    }
    
    function getName() public view returns(string memory){
        return name;
    }

    function getRec() public view check returns(string memory,string memory,uint,string memory){
        return (name, gender, age,record);
    }
    
    function setRec(string memory _rec) public check{
        record = _rec;
        emit makeChange(msg.sender);// who changed it.
    }   
}
```

智能合约是运行在以太坊上的一段代码，用户与智能合约提供的函数交互从而达到读取电子病历和存储电子病历的功能。`address payable public patient;` 存储了患者的账户，代表这份智能合约属于哪一位患者。合约中存储了患者的信息，包括姓名、年龄等。其中最为重要的是record和check两个变量，其中record存储的是病历的内容。前端App将病历的信息转换为json格式的字符串，存储在record中，每一份病历通过一定的标志进行分离。checker存储的是被授权的机构的地址，可以看做医院的凭证，其中checker对应的医院的医生有读取和写入record的权限。其中权限控制的代码在`modifier check()` 函数中，`msg.sender == myaddress || msg.sender == checker,` 这行代码保证了只有当发起人为患者或者是被授权的医院时，才可以访问智能合约中的数据，否则拒绝访问。

### 运行环境

![image-20190422230052961](https://ws2.sinaimg.cn/large/006tNc79gy1g2bt36at1oj30wi0ikwl6.jpg)

本系统的运行环境如下：

操作系统：macOS Mojave 版本10.14.4

处理器：2.2 GHz Intel Core i7

内存：16GB 2400 MHz DDR4

数据库：MongoDB

以太坊客户端：Ganache

### 开发技术

本系统基于Truffle框架搭建以太坊开发平台，通过Ganache搭建本地私有区块链进行验证，其中智能合约的开发语言为Solidity开发语言。

#### Solidity

Solidity是一种面向对象的高级语言，用于实现智能合约。 智能合约是管理以太坊内账户行为的程序。Solidity受C++，Python和JavaScript的影响，旨在针对以太坊虚拟机（EVM）。Solidity是静态类型的，支持继承，库和复杂的用户定义类型以及其他功能。通过Solidity，可以创建智能合约，例如投票，众筹，盲目拍卖和多重签名钱包。

#### Truffle

Truffle是一个基于以太坊虚拟机（EVM）的区块链开发环境，单元测试框架和资源管理中心，意义在于使开发人员的可以更加轻松的搭建以太坊开发环境。 通过Truffle，开发者可以：

+ 内置智能合约编译，链接，部署和二进制管理。
+ 快速开发的自动合同测试。
+ 可编写脚本的可扩展部署和迁移框架。
+ 用于部署到任意数量的公共和专用网络的网络管理。
+ 使用ERC190标准，使用EthPM和NPM进行包装管理。
+ 交互式控制台，用于直接合同通
+ 可配置的构建管道，支持紧密集成。
+ 在Truffle环境中执行脚本的外部脚本运行器。

#### Truffle-Contract

Truffle-Contract是对Web3.js的封装，是对以太坊智能合约的抽象，适用于Node和浏览器。

Truffle-Contract具有的特性：

+ 通过同步交易来获得更好的流量控制(在开发者确认已经开采之前，交易无法完成)
+ 承诺。减少回调地狱的产生，适用于ES6的async和await
+ 对交易提供默认值，例如address或者gas
+ 返回日志、交易的回调、同步产生的交易的哈希值

#### Ganache

Ganache是以太坊开发的个人区块链，可用于部署合同，开发应用程序和运行测试。它既可用作桌面应用程序，也可用作命令行工具（以前称为TestRPC）。Ganache适用于Windows，Mac和Linux。

#### Web3.js

web3.js是一个库集合，允许开发者使用HTTP，WebSocket或IPC连接与本地或远程以太坊节点进行交互。

### 界面设计和演示

本系统主要包括患者端和医生端两部分。

登录/注册界面可以选择以患者身份登录还是以医生身份登录：

![image-20190422235144444](https://ws1.sinaimg.cn/large/006tNc79gy1g2buk31a0nj30n41buaeb.jpg)

患者登录：

![image-20190424080616119](https://ws3.sinaimg.cn/large/006tNc79gy1g2degz9titj30mw1bg0w6.jpg)

登录成功后进入个人界面：

![image-20190424081614215](https://ws3.sinaimg.cn/large/006tNc79gy1g2derb74kfj30my1b2djl.jpg)



患者端主要查看病历和预约挂号两个功能

患者点击查看病历后可以看到自己的历史病历信息，包括就诊的医院名称、医生名称和就诊的时间：

![image-20190424081508023](https://ws4.sinaimg.cn/large/006tNc79gy1g2deq5xwr6j30na1beq79.jpg)



点击某一行的病历缩略信息可以查看详细的病历信息，包括医生的诊断证明等。

患者点击预约挂号后，App会显示目前已经注册了的医院的信息，患者可以根据自己的需要授权某家医院，医院拿到患者的授权后，医院下注册的医生就拥有了查看患者病历信息和给患者编写病历的权限。

![image-20190424081643257](https://ws4.sinaimg.cn/large/006tNc79gy1g2derubgdaj30n21ban0c.jpg)

给汕头附一医院授权，若授权成功，App会提示授权成功，反之提示授权失败：

![image-20190424081930550](https://ws4.sinaimg.cn/large/006tNc79gy1g2deupxuhbj30n41aw41p.jpg)

医生登录：

![image-20190424082054660](https://ws4.sinaimg.cn/large/006tNc79gy1g2dew6bk87j30n81b8dkk.jpg)

医生登录成功后会进入医生的主界面：

![image-20190424082128553](https://ws2.sinaimg.cn/large/006tNc79gy1g2dewreehgj30ng1bon38.jpg)

医生端主要可以进行"我要问诊"的操作，点击我要问诊：

![image-20190424082210106](https://ws3.sinaimg.cn/large/006tNc79gy1g2dexhlaslj30nc1b6jvi.jpg)

App上方有一个搜索框，通过输入患者的名称，医生可以查看到患者的历史病历信息：

![image-20190424082320499](https://ws2.sinaimg.cn/large/006tNc79gy1g2deypodwwj30ni1bmah2.jpg)

医生点击某一行的病历信息可以查看到患者以前的就诊信息，包括之前就诊的医院、就诊医生的姓名、就诊时间和以前医生开的处方等信息。医生对患者问诊结束后，点击新增按钮可以给患者新建一份病历，写入此次诊断证明：

![image-20190424082456014](https://ws1.sinaimg.cn/large/006tNc79gy1g2df0d19s8j30ny1c2jzh.jpg)

医生需要填写自己的姓名、所在医院及科室、诊断治疗的时间以及诊断结果和开设的处方信息。医生写入新的病历后，病历会写入到患者拥有的以太坊智能合约内，再次刷新App就可以看到刚才写入的新的病历信息。



## 问题与解决办法

### 遇到的问题

首先，区块链技术是比较新颖的一门技术，在对其开发前我们需要先了解其基本原理、工作机制。刚开始学习区块链时遇到的比较大的困难对共识机制的了解，共识机制指的是在分布式的环境下多个节点如何达成共识，在比特币中主要应用了工作量证明(Proof-of-Work)的方法。除此之外，对于时间戳服务器、双重支付的问题的理解也十分关键。

设计采用以太坊作为开发平台，以太坊是一个生态圈，含有许多的开发工具和开发框架。其中最重要的是Solidity语言，Solidity语言用来开发以太坊智能合约的语言，掌握其语法与特性十分重要。其次遇到的困难是学习Truffle框架，Truffle框架是一款以太坊的开发框架，帮助开发者优化了智能合约的编译、发布、交易等流程。Truffle框架还包含了一系列的子框架，包括：Truffle-Contract等。除此之外，对于Ganache等以太坊客户端的学习也十分困难，开发者要访问以太坊区块链必须通过相关客户端提供的API，有官方提供的Go语言客户端还有方便本地使用的Ganache客户端。其次，比较困难的是对于Web3.js库的学习，Web3.js库是一个封装了访问区块链相关API的JavaScrtpt库。简单来说，Web3.js是前端界面与区块链智能合约的桥梁，对于项目的搭建十分重要。

### 解决办法

接触一个新的领域，或者接触一门新的技术，都需要花大量的时间去熟悉才能掌握。特别是对于Solidity语言、Truffle框架、Web3.js库，国内非常少中文资源，最好的学习资料是官方文档。通过查阅官方文档，学习官方文档里的Demo，可以快速的入门。除了官方文档，Github上有非常优秀的开源项目，通过学习前人的代码，可以掌握高质量的开发技巧。

### 开发技巧

本系统的开发主要包括两方面：前端界面的开发和后台以太坊区块链的开发。合理的利用Truffle框架可以帮助开发者一键搭建项目，包括智能合约、前端项目、编译模块和服务器脚本。前端开发要注意与以太坊的接口对接，常见的可以通过Web3.js或者Truffle-contract库进行读取智能合约的示例，从而获取智能合约的数据和调用智能合约的函数。以太坊的开发则要合理利用Ganache工具，在本地搭建私有的区块链作为测试，可以迅速的返回结果，不需要等待出块的时间，方便开发者进行测试和开发。

## 总结与展望

### 总结

本文主要介绍了一个基于以太坊的电子病历安全存储和授权共享系统。对于区块链技术的基础知识和应用给予了简单的解释，还介绍了智能合约和以太坊的相关背景知识。

### 展望

本文介绍的基于以太坊的电子病历管理和共享系统还存在许多的不足和缺陷。一方面由于本文通过本地Ganache客户端搭建的本地私有链是免费的，但是如果大规模商业化，需要去以太坊平台注册相关密钥和信息，而以太坊需要收费，因为成本是非常大的一个考量。其次，以太坊是基于区块链设计的去中心化的分布式数据库，本身需要消耗大量的计算资源和电力资源，因此从资源利用的方面考虑，以太坊方案也有它天生的不足。最后，区块链中共识机制的达成需要相关算法的支持，而在以太坊中采用的权益证明（Proof-of-Stake，PoS，又译持有量证明）需要多个节点达成共识，实时性不高，如果将本系统大规模的应用在医疗系统中，系统的响应速度和Qps也许会成为最大的瓶颈。

综上所述，以太坊有着其天生的去中心化、不可篡改和匿名性的优点，但同时也具有收费高、资源消耗大、实时性低等缺点，综合以太坊平台的优点和缺点，本文认为可以将患者比较重要的医疗隐私信息通过以太坊平台存储，而与医疗敏感数据无关的个人信息等数据存储在相关机构的数据库即可。

## 致谢

牛顿曾经说过："我之所以能取得现在的成就，是因为我站在巨人的肩膀上"。同理，没有老师、同学、师兄和亲人的支持和鼓励，本文也难以如此快的完成。首先，我要感谢我的导师朱诗生老师，朱师生老师从毕业设计的选题、毕业设计的设计、毕业设计的中期进展到最终毕业论文的修改，都给予了本人偌大的帮助和指导。再次对朱老师对我的帮助和关怀表示诚挚的谢意！其次，还要感谢黄仁俊师兄，黄仁俊师兄利用自己的空余时间给我们讲解区块链的相关知识，以及目前关于区块链的发展情况，还将自己平时收集的资源无私的奉献给我们，对我论文的研究方向给出了许多意见和指导，对黄仁俊师兄表示诚挚的感谢！此外，我还要感谢我的搭档梁汉帮同学，梁汉帮同学对于以太坊平台和Web3.js等框架有深刻的见解，在NodeJS方面也有着深厚的编程功力，在他的协助写系统才能顺利的完成。最后，我要感谢我的父母，是他们的支持让我能一直坚持学习、坚持自己的研究方向，再次衷心感谢他们！

## 参考文献

[1] 梅颖. 安全存储医疗记录的区块链方法研究[J]. 江西师范大学学报(自然科学版)，2017，41(5):484-490.

[2] 曹敏姿，张琳琳，毕雪华，赵楷. 个性化(α ，l) - 多 样 性 k - 匿 名 隐 私 保 护 模 型[J]. 计算机科学，2018，45(11).

[3] Nakamoto S. Bitcoin: a peer-to-peer electronic cash system [Online], available: <http://bitcoin.org/bitcoin.pdf>, June 12, 2016

[4] 赵延红,原宝华,梁军.区块链技术在医疗领域中的应用探讨[J].中国医学教育技术,2018,32(01):1-7.

[5] 张亮,刘百祥,张如意,江斌鑫,刘一江.区块链技术综述[J/OL].计算机工程:1-15[2019-04-17].http://kns.cnki.net/kcms/detail/31.1289.TP.20190316.1352.002.html.

[6] 薛腾飞,傅群超,王枞,王新宴.基于区块链的医疗数据共享模型研究[J].自动化学报,2017,43(09):1555-1562.

[7] 袁勇,王飞跃.区块链技术发展现状与展望[J].自动化学报,2016,42(04):481-494.

[8] 邱欣欣,马兆丰,徐明昆.以太坊智能合约安全漏洞分析及对策[J].信息安全与通信保密,2019(02):44-53.

[9] 邵奇峰,金澈清,张召,钱卫宁,周傲英.区块链技术:架构及进展[J].计算机学报,2018,41(05):969-988.

[10]徐健,陈志德,龚平,王可可.基于区块链网络的医疗记录安全储存访问方案[J/OL].计算机应用:1-8[2019-04-27].http://kns.cnki.net/kcms/detail/51.1307.TP.20190121.1013.058.html.

